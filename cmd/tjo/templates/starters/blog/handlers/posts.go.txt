package handlers

import (
	"net/http"
	"strconv"

	"${APP_NAME}/data"
)

// PostsIndex displays all posts
func (h *Handlers) PostsIndex(w http.ResponseWriter, r *http.Request) {
	posts, err := h.Models.Posts.GetAll()
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.ErrorInternalServerError(w, r)
		return
	}

	vars := make(map[string]interface{})
	vars["posts"] = posts

	err = h.render(w, r, "posts/index", vars, nil)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

// PostsShow displays a single post
func (h *Handlers) PostsShow(w http.ResponseWriter, r *http.Request) {
	id, err := strconv.Atoi(r.PathValue("id"))
	if err != nil {
		h.App.ErrorNotFound(w, r)
		return
	}

	post, err := h.Models.Posts.Get(id)
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.ErrorNotFound(w, r)
		return
	}

	vars := make(map[string]interface{})
	vars["post"] = post

	err = h.render(w, r, "posts/show", vars, nil)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

// PostsNew displays the new post form
func (h *Handlers) PostsNew(w http.ResponseWriter, r *http.Request) {
	err := h.render(w, r, "posts/new", nil, nil)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

// PostsCreate creates a new post
func (h *Handlers) PostsCreate(w http.ResponseWriter, r *http.Request) {
	err := r.ParseForm()
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.ErrorBadRequest(w, r)
		return
	}

	post := data.Post{
		Title:   r.Form.Get("title"),
		Slug:    r.Form.Get("slug"),
		Content: r.Form.Get("content"),
	}

	_, err = h.Models.Posts.Insert(post)
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.ErrorInternalServerError(w, r)
		return
	}

	h.App.Session.Put(r.Context(), "flash", "Post created successfully!")
	http.Redirect(w, r, "/posts", http.StatusSeeOther)
}

// PostsEdit displays the edit post form
func (h *Handlers) PostsEdit(w http.ResponseWriter, r *http.Request) {
	id, err := strconv.Atoi(r.PathValue("id"))
	if err != nil {
		h.App.ErrorNotFound(w, r)
		return
	}

	post, err := h.Models.Posts.Get(id)
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.ErrorNotFound(w, r)
		return
	}

	vars := make(map[string]interface{})
	vars["post"] = post

	err = h.render(w, r, "posts/edit", vars, nil)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

// PostsUpdate updates an existing post
func (h *Handlers) PostsUpdate(w http.ResponseWriter, r *http.Request) {
	id, err := strconv.Atoi(r.PathValue("id"))
	if err != nil {
		h.App.ErrorNotFound(w, r)
		return
	}

	err = r.ParseForm()
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.ErrorBadRequest(w, r)
		return
	}

	post := data.Post{
		ID:      id,
		Title:   r.Form.Get("title"),
		Slug:    r.Form.Get("slug"),
		Content: r.Form.Get("content"),
	}

	err = h.Models.Posts.Update(post)
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.ErrorInternalServerError(w, r)
		return
	}

	h.App.Session.Put(r.Context(), "flash", "Post updated successfully!")
	http.Redirect(w, r, "/posts", http.StatusSeeOther)
}

// PostsDelete deletes a post
func (h *Handlers) PostsDelete(w http.ResponseWriter, r *http.Request) {
	id, err := strconv.Atoi(r.PathValue("id"))
	if err != nil {
		h.App.ErrorNotFound(w, r)
		return
	}

	err = h.Models.Posts.Delete(id)
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.ErrorInternalServerError(w, r)
		return
	}

	h.App.Session.Put(r.Context(), "flash", "Post deleted successfully!")
	http.Redirect(w, r, "/posts", http.StatusSeeOther)
}
